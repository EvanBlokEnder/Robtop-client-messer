<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GD Level Upload Demo</title>
  <style>
    body { font-family: Arial, sans-serif; background: #3979b8; color: white; padding: 20px; max-width: 600px; margin: auto;}
    input, button { padding: 10px; margin: 5px 0; width: 100%; }
    #uploadSection { display: none; margin-top: 20px; }
    .message { margin: 10px 0; }
  </style>
</head>
<body>
  <h1>GD Level Upload Demo</h1>
  <div id="authSection">
    <input type="text" id="username" placeholder="Username" autocomplete="username" />
    <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
    <button id="registerBtn">Register</button>
    <button id="loginBtn">Login</button>
    <div id="authMessage" class="message"></div>
  </div>

  <div id="uploadSection">
    <button id="uploadBtn">Upload Random Level</button>
    <pre id="uploadResult"></pre>
    <button id="logoutBtn">Logout</button>
  </div>

  <script>
    let sessionId = null;

    const authMessage = document.getElementById('authMessage');
    const uploadSection = document.getElementById('uploadSection');
    const authSection = document.getElementById('authSection');
    const uploadResult = document.getElementById('uploadResult');

    function showMessage(msg, isError=false) {
      authMessage.style.color = isError ? 'red' : 'lightgreen';
      authMessage.textContent = msg;
    }

    async function postData(url = '', data = {}) {
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      return res.json();
    }

    async function register() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!username || !password) {
        showMessage('Enter username and password', true);
        return;
      }
      const res = await postData('/api/auth', { action: 'register', username, password });
      if (res.success) {
        sessionId = res.sessionId;
        showLoggedIn();
      } else {
        showMessage(res.error || 'Register failed', true);
      }
    }

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!username || !password) {
        showMessage('Enter username and password', true);
        return;
      }
      const res = await postData('/api/auth', { action: 'login', username, password });
      if (res.success) {
        sessionId = res.sessionId;
        showLoggedIn();
      } else {
        showMessage(res.error || 'Login failed', true);
      }
    }

    function showLoggedIn() {
      showMessage('Logged in successfully!');
      authSection.style.display = 'none';
      uploadSection.style.display = 'block';
      uploadResult.textContent = '';
    }

    async function uploadRandomLevel() {
      if (!sessionId) return;
      const res = await postData('/api/upload', { sessionId });
      if (res.success) {
        uploadResult.textContent = JSON.stringify(res.uploadedLevel, null, 2);
      } else {
        uploadResult.textContent = 'Upload failed: ' + (res.error || 'Unknown error');
      }
    }

    function logout() {
      sessionId = null;
      authSection.style.display = 'block';
      uploadSection.style.display = 'none';
      authMessage.textContent = '';
      uploadResult.textContent = '';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    }

    document.getElementById('registerBtn').addEventListener('click', register);
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('uploadBtn').addEventListener('click', uploadRandomLevel);
    document.getElementById('logoutBtn').addEventListener('click', logout);
  </script>
</body>
</html>
